graph TD
    %% Styles - Updated Palette
    classDef api fill:#E1BEE7,stroke:#6A1B9A,stroke-width:2px;
    classDef service fill:#C5CAE9,stroke:#303F9F,stroke-width:2px;
    classDef agent fill:#C8E6C9,stroke:#2E7D32,stroke-width:2px;
    classDef model fill:#FFF9C4,stroke:#F9A825,stroke-width:2px;
    classDef db fill:#FFCCBC,stroke:#D84315,stroke-width:2px;
    classDef util fill:#B3E5FC,stroke:#0277BD,stroke-width:2px;
    classDef config fill:#F5F5F5,stroke:#616161,stroke-width:1px;
    classDef external fill:#E0E0E0,stroke:#757575,stroke-width:1px,stroke-dasharray: 5 5;
    classDef entry fill:#D1C4E9,stroke:#4527A0,stroke-width:2px;

    %% Entry Point
    subgraph "Entry & Config"
        direction LR
        M(main.py):::entry
        C(config.py):::config
        R(requirements.txt):::config
        E(env .env/.env.example):::config
        INIT(__init__.py):::config
    end

    %% API Layer
    subgraph API Layer
        direction LR
        M -- includes router --> TA(api/transcript_api.py):::api
        M -- calls --> AA_func(api/agent_api.py create_agent_api):::api
        M -- calls --> RA_func(api/resource_api.py create_resource_api):::api
        M -- includes router --> SA(api/speech_api.py):::api
        AA(api/agent_api.py):::api
        RA(api/resource_api.py):::api
        AA_func --> AA
        RA_func --> RA

        subgraph Schemas
            direction TB
            SC_S(schemas/session.py):::model
            SC_T(schemas/transcripts.py):::model
        end
        AA --> SC_S
        TA --> SC_T
    end

    %% Service Layer
    subgraph Service Layer
        direction TB
        S_INIT(services/__init__.py):::service
        S_SM(services/session_manager.py SessionManagerService):::service
        S_TS(services/transcript_service.py TranscriptService):::service
        S_SS(services/search_service.py SearchService):::service
        S_LLM(services/llm_service.py LLMService):::service
        S_DM(services/data_management.py DataManagementService):::service
        S_PROVIDER(services/__init__.py ServiceProvider):::service

        M -- calls --> S_INIT
        S_INIT -- initializes --> S_PROVIDER
        S_PROVIDER -- provides --> S_SM
        S_PROVIDER -- provides --> S_TS
        S_PROVIDER -- provides --> S_SS
        S_PROVIDER -- provides --> S_LLM
        S_PROVIDER -- provides --> S_DM

        %% Service Interactions
        AA -->|calls methods| S_SM
        TA -->|calls methods| S_TS
        RA -->|calls methods| S_TS
        %% Assumed interaction for resource/transcript link
        RA -->|calls methods| S_DM
        %% Assumed interaction for tracking/feedback

        %% Service Dependencies
        S_SM -->|instantiates/manages| Ag_O(agents/orchestrator.py AgentSessionManager)
        S_SM -->|uses models| M_I(models/interview.py InterviewSession)
        S_SM -->|uses DB session| DB_Conn(database/connection.py)

        S_TS -->|uses models| M_T(models/transcript.py Transcript Models)
        S_TS -->|uses DB session| DB_Conn
        S_TS -->|uses| U_EB(utils/event_bus.py EventBus)
        %% Publishes transcript events
        S_TS -->|potentially uses| U_VS(utils/vector_store.py VectorStore)

        S_SS -->|uses external| EXT_Search(External Search APIs):::external
        S_SS -->|uses| U_VS
        %% Assumed for potential local resource indexing

        S_DM -->|uses models| M_I
        %% Uses InterviewSession minimally
        S_DM -->|uses| U_EB
        %% Subscribes to user/agent response events
    end

    %% Agent Layer
    subgraph Agent Layer
        direction TB
        Ag_B(agents/base.py BaseAgent/AgentContext):::agent
        Ag_O --> Ag_B
        %% Inherits/Uses
        Ag_I(agents/interviewer.py InterviewerAgent):::agent
        Ag_C(agents/coach.py CoachAgent):::agent
        Ag_SA(agents/skill_assessor.py SkillAssessorAgent):::agent

        Ag_I --> Ag_B 
        %% Inherits
        Ag_C --> Ag_B 
        %% Inherits
        Ag_SA --> Ag_B 
        %% Inherits

        %% Orchestrator Interactions
        Ag_O -- instantiates --> Ag_I
        Ag_O -- instantiates --> Ag_C
        Ag_O -- instantiates --> Ag_SA
        Ag_O -- uses --> S_LLM
        Ag_O -- uses --> U_EB
        Ag_O -- uses --> M_I
        %% Uses InterviewSession config

        %% Agent Context
        Ag_B -- contains --> M_I
        %% AgentContext holds InterviewSession
        Ag_B -- contains --> U_EB
        %% AgentContext holds EventBus

        %% Individual Agent Dependencies & Events
        Ag_I -- uses --> S_LLM
        Ag_I -- uses --> U_EB
        Ag_I -- uses --> U_LU(utils/llm_utils.py)
        Ag_I -- uses enum --> M_I
        %% InterviewStyle
        Ag_I -- publishes INTERVIEWER_QUESTION --> U_EB
        Ag_I -- publishes INTERVIEW_COMPLETED --> U_EB
        Ag_I -- subscribes SESSION_START --> U_EB
        Ag_I -- subscribes SESSION_END --> U_EB
        Ag_I -- subscribes SESSION_RESET --> U_EB

        Ag_C -- uses --> S_LLM
        Ag_C -- uses --> U_EB
        Ag_C -- uses --> U_LU
        Ag_C -- subscribes interviewer_response --> U_EB
        %% Mismatch: Likely ASSISTANT_RESPONSE or INTERVIEWER_QUESTION
        Ag_C -- subscribes user_response --> U_EB
        %% Mismatch: Likely USER_MESSAGE
        Ag_C -- subscribes interview_summary --> U_EB
        %% Mismatch: EventType not defined
        Ag_C -- subscribes COACHING_REQUEST --> U_EB
        Ag_C -- publishes coaching_summary_generated --> U_EB
        %% Mismatch: EventType not defined

        Ag_SA -- uses --> S_LLM
        Ag_SA -- uses --> U_EB
        Ag_SA -- uses --> S_SS
        Ag_SA -- uses --> U_LU
        Ag_SA -- subscribes interviewer_response --> U_EB
        %% Mismatch: Likely ASSISTANT_RESPONSE or INTERVIEWER_QUESTION
        Ag_SA -- subscribes user_response --> U_EB
        %% Mismatch: Likely USER_MESSAGE
        Ag_SA -- subscribes interview_summary --> U_EB
        %% Mismatch: EventType not defined
        Ag_SA -- subscribes SESSION_START --> U_EB
        Ag_SA -- subscribes SESSION_RESET --> U_EB
        Ag_SA -- publishes skill_extracted --> U_EB
        %% Mismatch: EventType not defined
        Ag_SA -- publishes skill_assessed --> U_EB
        %% Mismatch: EventType not defined
        Ag_SA -- publishes resources_suggested --> U_EB
        %% Mismatch: EventType not defined
        Ag_SA -- publishes SKILL_ASSESSMENT --> U_EB
        %% For final profile

    end

    %% Utils Layer
    subgraph Utility Layer
        direction TB
        U_EB -- defines --> EVT(Event/EventType)
        U_LU -- contains --> LLMHelpers(format_history, parse_json, invoke_chain)
        U_VS -- contains --> VectorStoreClass(FAISS/SentenceTransformer)
    end

    %% Data Layer
    subgraph Data Layer
        direction TB
        subgraph Models
            direction TB
            M_I -- defines --> EnumsI(Interview Enums)
            M_I -- defines --> InterviewSessionClass
            M_I -- defines --> QuestionClass
            M_I -- defines --> AnswerClass
            M_I -- defines --> SkillAssessmentClass
            M_I -- defines --> ResourceClass
            M_I -- defines --> MessageClass
            M_T(models/transcript.py):::model
            M_T -- defines --> TranscriptClass
            M_T -- defines --> TranscriptTagClass
            M_T -- defines --> Embedding/FragmentClasses
            M_U(models/user.py User):::model
        end
        subgraph Database
            direction TB
            DB_Conn(database/connection.py):::db
            DB_Conn -- defines --> get_db(get_db func)
            DB_Conn -- defines --> init_db(init_db func)
            DB_Conn -- uses --> M_I
            DB_Conn -- uses --> M_T
            DB_Conn -- uses --> M_U
            DB_File(interview_app.db):::db
            DB_Conn --> DB_File
        end
    end

    %% Cross-Layer Connections
    M -- calls --> init_db 
    %% Startup
    AA -->|uses| get_db 
    %% API routes get DB session
    TA -->|uses| get_db
    RA -->|uses| get_db
    S_SM -->|uses| get_db
    S_TS -->|uses| get_db
    S_DM -->|uses| get_db

    Ag_O -- publishes SESSION_START --> U_EB
    Ag_O -- publishes USER_MESSAGE --> U_EB
    Ag_O -- publishes ASSISTANT_RESPONSE --> U_EB
    Ag_O -- publishes SESSION_END --> U_EB
    Ag_O -- publishes SESSION_RESET --> U_EB
    Ag_O -- publishes AGENT_LOAD --> U_EB
    Ag_O -- publishes ERROR --> U_EB

    S_TS -- publishes TRANSCRIPT_CREATED --> U_EB
    S_TS -- publishes TRANSCRIPT_UPDATED --> U_EB
    S_TS -- publishes TRANSCRIPT_DELETED --> U_EB

    %% Class Definitions
    classDef default fill:#fff,stroke:#333,stroke-width:2px;
